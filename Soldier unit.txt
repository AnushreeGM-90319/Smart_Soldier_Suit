/* 
   FINAL SOLDIER UNIT (FULL INTEGRATION)
   - GPS (Pins 32/33)
   - Oxygen Knob (Pin 35)
   - Ultrasonic (Pins 5/18) + Motion Detection
   - Temp (Pin 4)
   - Panic Button (Pin 13)
   - Heart Rate (Simulated for Stability)
   - Radio (ESP-NOW)
*/

#include <esp_now.h>
#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>
#include <TinyGPS++.h>

// --- YOUR BASE STATION MAC ADDRESS ---
// (Make sure this matches the address you found earlier)
uint8_t broadcastAddress[] = {0x00, 0x70, 0x07, 0x1D, 0x2C, 0x7C};

// OLED Settings
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// DHT11 Temp Sensor
#define DHTPIN 4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// Pins
const int trigPin = 5;
const int echoPin = 18;
const int buttonPin = 13;
const int oxygenPin = 35; 

// GPS Settings (Using Pins 32 & 33)
TinyGPSPlus gps;
#define RXD2 32
#define TXD2 33

// Variables
int simBPM = 75; 
unsigned long lastSimUpdate = 0;
int prevDistance = 0;
bool isMoving = false;
int oxygenLevel = 100;

// Data Structure (Matches Base Station)
typedef struct struct_message {
  int id;
  float temp;
  int distance;
  bool panic;
  double lat;
  double lng;
  int bpm;
  int oxygen;
  bool moving; 
} struct_message;

struct_message myData;
esp_now_peer_info_t peerInfo;
unsigned long lastSendTime = 0;

void setup() {
  Serial.begin(115200);
  
  // 1. Start GPS Serial
  Serial2.begin(9600, SERIAL_8N1, RXD2, TXD2); 

  // 2. Setup Pins
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(oxygenPin, INPUT); 

  dht.begin();

  // 3. Init OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println("OLED Failed"); for(;;); 
  }
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.setTextSize(1);
  display.setCursor(0,0);
  display.println("SYSTEM LOADING...");
  display.println("GPS: Searching...");
  display.display();
  delay(1000);

  // 4. Init Radio
  WiFi.mode(WIFI_STA);
  if (esp_now_init() != ESP_OK) return;
  memcpy(peerInfo.peer_addr, broadcastAddress, 6);
  peerInfo.channel = 0;  
  peerInfo.encrypt = false;
  esp_now_add_peer(&peerInfo);
}

void loop() {
  // --- A. READ OXYGEN (Potentiometer) ---
  int rawO2 = analogRead(oxygenPin);
  oxygenLevel = map(rawO2, 0, 4095, 0, 100);

  // --- B. GPS LOGIC ---
  while (Serial2.available() > 0) gps.encode(Serial2.read());
  if (gps.location.isValid()) {
    myData.lat = gps.location.lat();
    myData.lng = gps.location.lng();
  }

  // --- C. SIMULATE HEART RATE ---
  // Updates every 2 seconds
  if (millis() - lastSimUpdate > 2000) {
    simBPM = random(72, 82); // Normal Range
    // If Panic Button Pressed -> High Heart Rate
    if (digitalRead(buttonPin) == LOW) simBPM = random(115, 135);
    lastSimUpdate = millis();
  }

  // --- D. SEND DATA & UPDATE SCREEN (Every 250ms) ---
  if (millis() - lastSendTime > 250) {
    
    // Fill Data Packet
    myData.oxygen = oxygenLevel; 
    
    float t = dht.readTemperature();
    myData.temp = isnan(t) ? 0.0 : t;
    
    // Ultrasonic Logic
    digitalWrite(trigPin, LOW); delayMicroseconds(2);
    digitalWrite(trigPin, HIGH); delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    long duration = pulseIn(echoPin, HIGH);
    int currentDist = duration * 0.034 / 2;
    
    // Movement Detection Logic
    if (abs(currentDist - prevDistance) > 5 && currentDist < 200) {
      isMoving = true;
    } else {
      isMoving = false;
    }
    prevDistance = currentDist;
    myData.distance = currentDist;

    myData.panic = (digitalRead(buttonPin) == LOW);
    myData.bpm = simBPM; 
    myData.moving = isMoving;
    myData.id = 1;

    // Send via ESP-NOW
    esp_now_send(broadcastAddress, (uint8_t *) &myData, sizeof(myData));

    // Update OLED Display
    display.clearDisplay();
    
    // Top Row: BPM and Oxygen
    display.setCursor(0,0);
    display.print("BPM:"); display.print(simBPM);
    display.print("  O2:"); display.print(oxygenLevel); display.print("%");
    
    // Middle Row: GPS Status and Temp
    display.setCursor(0,12);
    display.print("GPS:"); 
    if(myData.lat > 0) display.print("OK "); else display.print("-- ");
    display.print(" T:"); display.print((int)myData.temp); display.print("C");

    // Distance Row
    display.setCursor(0,24);
    display.print("Dst:"); display.print(myData.distance); display.print("cm");

    // Bottom Status Bar
    display.fillRect(0, 38, 128, 26, WHITE);
    display.setTextColor(BLACK); 
    display.setCursor(20, 46);
    
    if(myData.panic) display.print("SOS ALERT!");
    else if(myData.moving) display.print("MOVING OBJ!");
    else display.print("AREA CLEAR");
    
    display.setTextColor(WHITE); // Switch back to white text
    display.display();
    
    lastSendTime = millis();
  }/* 
   FINAL SOLDIER UNIT (FULL INTEGRATION)
   - GPS (Pins 32/33)
   - Oxygen Knob (Pin 35)
   - Ultrasonic (Pins 5/18) + Motion Detection
   - Temp (Pin 4)
   - Panic Button (Pin 13)
   - Heart Rate (Simulated for Stability)
   - Radio (ESP-NOW)
*/

#include <esp_now.h>
#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>
#include <TinyGPS++.h>

// --- YOUR BASE STATION MAC ADDRESS ---
// (Make sure this matches the address you found earlier)
uint8_t broadcastAddress[] = {0x00, 0x70, 0x07, 0x1D, 0x2C, 0x7C};

// OLED Settings
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// DHT11 Temp Sensor
#define DHTPIN 4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// Pins
const int trigPin = 5;
const int echoPin = 18;
const int buttonPin = 13;
const int oxygenPin = 35; 

// GPS Settings (Using Pins 32 & 33)
TinyGPSPlus gps;
#define RXD2 32
#define TXD2 33

// Variables
int simBPM = 75; 
unsigned long lastSimUpdate = 0;
int prevDistance = 0;
bool isMoving = false;
int oxygenLevel = 100;

// Data Structure (Matches Base Station)
typedef struct struct_message {
  int id;
  float temp;
  int distance;
  bool panic;
  double lat;
  double lng;
  int bpm;
  int oxygen;
  bool moving; 
} struct_message;

struct_message myData;
esp_now_peer_info_t peerInfo;
unsigned long lastSendTime = 0;

void setup() {
  Serial.begin(115200);
  
  // 1. Start GPS Serial
  Serial2.begin(9600, SERIAL_8N1, RXD2, TXD2); 

  // 2. Setup Pins
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(oxygenPin, INPUT); 

  dht.begin();

  // 3. Init OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    Serial.println("OLED Failed"); for(;;); 
  }
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.setTextSize(1);
  display.setCursor(0,0);
  display.println("SYSTEM LOADING...");
  display.println("GPS: Searching...");
  display.display();
  delay(1000);

  // 4. Init Radio
  WiFi.mode(WIFI_STA);
  if (esp_now_init() != ESP_OK) return;
  memcpy(peerInfo.peer_addr, broadcastAddress, 6);
  peerInfo.channel = 0;  
  peerInfo.encrypt = false;
  esp_now_add_peer(&peerInfo);
}

void loop() {
  // --- A. READ OXYGEN (Potentiometer) ---
  int rawO2 = analogRead(oxygenPin);
  oxygenLevel = map(rawO2, 0, 4095, 0, 100);

  // --- B. GPS LOGIC ---
  while (Serial2.available() > 0) gps.encode(Serial2.read());
  if (gps.location.isValid()) {
    myData.lat = gps.location.lat();
    myData.lng = gps.location.lng();
  }

  // --- C. SIMULATE HEART RATE ---
  // Updates every 2 seconds
  if (millis() - lastSimUpdate > 2000) {
    simBPM = random(72, 82); // Normal Range
    // If Panic Button Pressed -> High Heart Rate
    if (digitalRead(buttonPin) == LOW) simBPM = random(115, 135);
    lastSimUpdate = millis();
  }

  // --- D. SEND DATA & UPDATE SCREEN (Every 250ms) ---
  if (millis() - lastSendTime > 250) {
    
    // Fill Data Packet
    myData.oxygen = oxygenLevel; 
    
    float t = dht.readTemperature();
    myData.temp = isnan(t) ? 0.0 : t;
    
    // Ultrasonic Logic
    digitalWrite(trigPin, LOW); delayMicroseconds(2);
    digitalWrite(trigPin, HIGH); delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    long duration = pulseIn(echoPin, HIGH);
    int currentDist = duration * 0.034 / 2;
    
    // Movement Detection Logic
    if (abs(currentDist - prevDistance) > 5 && currentDist < 200) {
      isMoving = true;
    } else {
      isMoving = false;
    }
    prevDistance = currentDist;
    myData.distance = currentDist;

    myData.panic = (digitalRead(buttonPin) == LOW);
    myData.bpm = simBPM; 
    myData.moving = isMoving;
    myData.id = 1;

    // Send via ESP-NOW
    esp_now_send(broadcastAddress, (uint8_t *) &myData, sizeof(myData));

    // Update OLED Display
    display.clearDisplay();
    
    // Top Row: BPM and Oxygen
    display.setCursor(0,0);
    display.print("BPM:"); display.print(simBPM);
    display.print("  O2:"); display.print(oxygenLevel); display.print("%");
    
    // Middle Row: GPS Status and Temp
    display.setCursor(0,12);
    display.print("GPS:"); 
    if(myData.lat > 0) display.print("OK "); else display.print("-- ");
    display.print(" T:"); display.print((int)myData.temp); display.print("C");

    // Distance Row
    display.setCursor(0,24);
    display.print("Dst:"); display.print(myData.distance); display.print("cm");

    // Bottom Status Bar
    display.fillRect(0, 38, 128, 26, WHITE);
    display.setTextColor(BLACK); 
    display.setCursor(20, 46);
    
    if(myData.panic) display.print("SOS ALERT!");
    else if(myData.moving) display.print("MOVING OBJ!");
    else display.print("AREA CLEAR");
    
    display.setTextColor(WHITE); // Switch back to white text
    display.display();
    
    lastSendTime = millis();
  }